import"./sweetalert2.esm.all-GP8esQtv.js";import{s as A}from"./supabase-CFADINa5.js";import{u as l}from"./ui-Bl61D2-M.js";import{p as H}from"./api-Ddpk_UT3.js";const T=(e,o=document)=>o.querySelector(e),S=T("#mesasContainer"),N=T("#confirmBtn");T("#anio").textContent=new Date().getFullYear();const F="/api/confirmar",k=new URLSearchParams(window.location.search).get("token");if(!k)throw l.error("No se encontró el token de acceso."),new Error("Token faltante");let n={invitado:null,mesas:[],confirmed:[],draft:[],pendingMove:null,draftCounter:0,realtimeChannel:null,realtimeSyncing:!1,realtimeQueued:!1,lastRealtimeNoticeAt:0};const y=(e,o)=>`${e}:${o}`;function D(){const e=n.invitado||{};return(e.opciones_comun||0)+(e.opciones_celiacos||0)+(e.opciones_vegetarianos||0)+(e.opciones_veganos||0)}function Q(){n.draft=n.confirmed.map(e=>({...e,clientId:`seat-${e.id}`,originalMesaId:e.mesa_id,originalPosicion:e.posicion,isNew:!1,isMoved:!1})),n.pendingMove=null,q()}function Y(){const e=new Map;return n.draft.forEach(o=>{o.mesa_id&&o.posicion&&e.set(y(o.mesa_id,o.posicion),o)}),e}function O(){if(n.draft.length!==n.confirmed.length)return!0;const e=new Map;n.confirmed.forEach(o=>e.set(o.id,o));for(const o of n.draft)if(!o.id||!e.get(o.id)||o.mesa_id!==o.originalMesaId||o.posicion!==o.originalPosicion)return!0;return!1}function U(){return n.draft.length!==D()}function q(){const e=O(),o=U();if(!e||o){N.classList.add("hidden"),N.disabled=!0;return}N.classList.remove("hidden"),N.disabled=!1}function j(){const e=D(),o=!!n.pendingMove,i=Math.max(n.draft.length-(o?1:0),0),t=Math.max(e-i,0),a=O()?'<span class="text-orange-500 font-semibold">Tenés cambios sin confirmar.</span>':'<span class="text-green-600 font-semibold">Todo guardado.</span>',u=`
    <div class="mb-6 text-center bg-white/90 p-4 rounded-xl shadow">
      <p class="text-azuloscuro font-semibold">
        Tenés <b>${e}</b> asiento${e!==1?"s":""} disponible${e!==1?"s":""}.
      </p>
      <p class="text-sm text-gray-600">
        Seleccionaste ${i}, te quedan ${t}.
      </p>
      <p class="text-xs text-gray-500 mt-1">
        Podés confirmar los cambios de cada asiento hasta <b>2 veces</b>.
      </p>
      <p class="text-xs mt-2">${a}</p>
      ${o?'<p class="text-sm text-azuloscuro mt-3 font-semibold">Estás moviendo un asiento: elegí el nuevo lugar para finalizar.</p>':""}
      
    <div class="mt-3 text-sm text-gray-600">
      <p>Para cambiar un asiento, tocá uno de los tuyos y después elegí el nuevo lugar.</p>
      <p class="mt-1 text-xs text-gray-500">Mientras estás moviendo un asiento, ese lugar queda momentáneamente libre hasta que elijas otro.</p>
    </div>
  
    </div>
  `;T("#estadoAsientos")?.remove();const r=document.createElement("div");r.id="estadoAsientos",r.innerHTML=u,S.before(r)}function J(e){const o=new Map;return(e||[]).forEach(i=>{(i.mesa_asientos||[]).forEach(t=>{t&&o.set(y(i.id,t.posicion),{mesa_id:i.id,...t})})}),o}function V(e,o,{preserveDraft:i=!1}={}){const t=e||[],s=[],a=J(t);if(t.forEach(r=>{(r.mesa_asientos||[]).forEach(p=>{p?.invitado_id===o&&s.push({id:p.id,mesa_id:r.id,posicion:p.posicion,cambios:p.cambios||0})})}),n.mesas=t,n.confirmed=s,!i)return Q(),{removedKeys:[],occupancy:a};const d=[],c=[],u=n.pendingMove?y(n.pendingMove.fromMesaId,n.pendingMove.fromPosicion):null;if(n.draft.forEach(r=>{const p=y(r.mesa_id,r.posicion),v=a.get(p);if(v&&v.invitado_id&&v.invitado_id!==o){c.push(p);return}v&&v.invitado_id===o&&(r.id=v.id,r.cambios=v.cambios||0,r.isNew=!1),d.push(r)}),n.draft=d,u){const r=a.get(u);(!r||r.invitado_id!==o)&&(n.pendingMove=null)}return n.draft.forEach(r=>{r.isMoved=r.mesa_id!==r.originalMesaId||r.posicion!==r.originalPosicion}),{removedKeys:c,occupancy:a}}async function $({showLoading:e=!1,preserveDraft:o=!1,loadingMessage:i="Actualizando mesas..."}={}){try{if(e&&l.loading(i),!n.invitado||!o){const{data:d,error:c}=await A.from("invitados").select("*").eq("mesa_token",k).maybeSingle();if(c||!d)throw new Error("Token inválido");n.invitado=d}const{data:t,error:s}=await A.from("mesas").select(`
        id,
        numero,
        capacidad,
        mesa_asientos (
          id,
          posicion,
          invitado_id,
          cambios,
          invitados ( nombre )
        )
      `).order("numero",{ascending:!0});if(s)throw s;const{removedKeys:a}=V(t,n.invitado.id,{preserveDraft:o});if(M(),o&&a.length){const d=Date.now();if(d-n.lastRealtimeNoticeAt>3e3){const c=a.length===1?"Un asiento que estabas mirando fue tomado por otra persona. Actualizamos tu selección.":"Algunos asientos que estabas mirando fueron tomados por otras personas. Actualizamos tu selección.";l.info(c),n.lastRealtimeNoticeAt=d}}}catch(t){console.error(t),o||l.error("Error al cargar las mesas.")}finally{e&&l.close()}}function G(){S.innerHTML="";const e=Y(),o=n.pendingMove?y(n.pendingMove.fromMesaId,n.pendingMove.fromPosicion):null;n.mesas.forEach(i=>{const t=document.createElement("div");t.className="bg-white/90 rounded-2xl shadow-md p-5 flex flex-col items-center text-center transition-transform hover:scale-105 m-2";const s=document.createElement("h2");s.className="text-azuloscuro font-bold mb-4",s.textContent=`Mesa ${i.numero}`,t.appendChild(s);const a=document.createElement("div");a.className="grid grid-cols-4 gap-3";const d=i.capacidad||8;for(let c=1;c<=d;c+=1){const u=(i.mesa_asientos||[]).find(P=>P.posicion===c)||null,r=y(i.id,c),p=e.get(r),v=u?.invitado_id&&u.invitado_id!==n.invitado.id,C=!!u&&u.invitado_id===n.invitado.id,I=!!p,E=p?.isNew||p?.isMoved,z=o===r,f=document.createElement("button");f.dataset.mesa=i.id,f.dataset.pos=c,f.className="asiento w-12 h-12 rounded-full flex items-center justify-center transition border";const m=document.createElement("i");m.classList.add("fa-solid");let b="Disponible",g="Disponible",h="text-transparent";v?(f.classList.add("bg-rojo","text-white","cursor-not-allowed"),f.disabled=!0,m.classList.add("fa-user-slash"),b=u?.invitados?.nombre||"Ocupado",g=u?.invitados?.nombre||"Ocupado",h="text-gray-800"):z&&C?(f.classList.add("border-2","border-dashed","border-azuloscuro","bg-azuloscuro/10","text-azuloscuro"),m.classList.add("fa-person-walking-arrow-right"),b="Liberado para mover",g="Elegí tu nuevo asiento",h="text-azuloscuro font-semibold"):I?(f.classList.add("border-4","border-emerald-400","bg-emerald-50"),m.classList.add("fa-star","text-emerald-500"),b=E?"Nuevo asiento seleccionado":"Tu asiento",g=E?"Nuevo":"Confirmado",h="text-emerald-600"):C?(f.classList.add("border-4","border-yellow-400","bg-yellow-50"),m.classList.add("fa-star","text-yellow-400"),b="Tu asiento actual",g="Actual",h="text-yellow-500"):(f.classList.add("border","border-celeste","hover:border-azuloscuro","hover:bg-celeste/20"),m.classList.add("fa-chair","text-amber-800")),f.title=b,f.appendChild(m);const x=document.createElement("div");x.className="flex flex-col items-center justify-center text-center",x.appendChild(f);const _=document.createElement("p");_.className=`text-sm mt-1 max-w-[120px] leading-tight ${h}`,_.textContent=g==="Disponible"?".":g,x.appendChild(_),a.appendChild(x)}t.appendChild(a),S.appendChild(t)})}function M(){j(),G(),q()}function L(){j(),q()}function w(e,o){const i=n.mesas.find(P=>P.id===e);if(!i)return!1;const t=S.querySelector(`.asiento[data-mesa="${e}"][data-pos="${o}"]`);if(!t)return!1;const s=t.querySelector("i"),a=t.parentElement?.querySelector("p"),d=(i.mesa_asientos||[]).find(P=>P.posicion===o)||null,c=R(e,o),u=n.invitado?.id,r=n.pendingMove?y(n.pendingMove.fromMesaId,n.pendingMove.fromPosicion):null,p=y(e,o),v=d?.invitado_id&&d.invitado_id!==u,C=!!d&&d.invitado_id===u,I=!!c,E=c?.isNew||c?.isMoved,z=r===p;let f="asiento w-12 h-12 rounded-full flex items-center justify-center transition border",m="";const b=["fa-solid"];let g="Disponible",h="text-transparent",x="Disponible",_=!1;return v?(m="bg-rojo text-white cursor-not-allowed",b.push("fa-user-slash"),x=d?.invitados?.nombre||"Ocupado",g=d?.invitados?.nombre||"Ocupado",h="text-gray-800",_=!0):z&&C?(m="border-2 border-dashed border-azuloscuro bg-azuloscuro/10 text-azuloscuro",b.push("fa-person-walking-arrow-right"),x="Liberado para mover",g="Elegí tu nuevo asiento",h="text-azuloscuro font-semibold"):I?(m="border-4 border-emerald-400 bg-emerald-50",b.push("fa-star","text-emerald-500"),x=E?"Nuevo asiento seleccionado":"Tu asiento",g=E?"Nuevo":"Confirmado",h="text-emerald-600"):C?(m="border-4 border-yellow-400 bg-yellow-50",b.push("fa-star","text-yellow-400"),x="Tu asiento actual",g="Actual",h="text-yellow-500"):(m="border-celeste hover:border-azuloscuro hover:bg-celeste/20",b.push("fa-chair","text-amber-800")),t.className=`${f} ${m}`.trim(),t.disabled=_,t.title=x,s&&(s.className=b.join(" ")),a&&(a.className=`text-sm mt-1 max-w-[120px] leading-tight ${h}`.trim(),a.textContent=g==="Disponible"?".":g),!0}function R(e,o){return n.draft.find(i=>i.mesa_id===e&&i.posicion===o)}function W(e){return n.draft.find(o=>o.clientId===e)}function X(e,o,i){if(n.pendingMove){l.info("Primero ubicá el asiento que ya estás moviendo.");return}if(e.cambios>=2){l.info("No podés cambiar este asiento más de 2 veces.");return}const t=e.originalMesaId??o,s=e.originalPosicion??i,a=e.mesa_id,d=e.posicion;e.id&&(e.mesa_id!==t||e.posicion!==s)&&(e.mesa_id=t,e.posicion=s,e.isMoved=!1,w(a,d)||M()),n.pendingMove={clientId:e.clientId,fromMesaId:e.mesa_id,fromPosicion:e.posicion},w(t,s)||M(),L()}function K(){const e=n.pendingMove;n.pendingMove=null,e&&(w(e.fromMesaId,e.fromPosicion)||M()),L()}function Z(e){n.draft=n.draft.filter(o=>o.clientId!==e.clientId),w(e.mesa_id,e.posicion)||M(),L()}function ee(e,o){const i=n.pendingMove;if(!i)return;const t=W(i.clientId);if(!t){K();return}if(R(e,o)){l.info("Ya seleccionaste ese lugar. Elegí otro.");return}t.mesa_id=e,t.posicion=o,t.isMoved=t.mesa_id!==t.originalMesaId||t.posicion!==t.originalPosicion,n.pendingMove=null;const a=w(i.fromMesaId,i.fromPosicion),d=w(e,o);(!a||!d)&&M(),L()}function oe(e,o){const i=D();if(n.draft.length>=i){l.info("Ya seleccionaste todos tus asientos disponibles.");return}n.draftCounter+=1,n.draft.push({id:null,mesa_id:e,posicion:o,cambios:0,isNew:!0,isMoved:!1,originalMesaId:null,originalPosicion:null,clientId:`new-${n.draftCounter}`}),w(e,o)||M(),L()}function ne(e,o){const i=n.mesas.find(c=>c.id===e);if(!i)return;const t=(i.mesa_asientos||[]).find(c=>c.posicion===o)||null,s=R(e,o),a=n.pendingMove;if(t?.invitado_id&&t.invitado_id!==n.invitado.id){l.info("Ese asiento ya está ocupado.");return}if(s&&s.isNew){Z(s);return}if(a&&a.fromMesaId===e&&a.fromPosicion===o){K();return}if(s&&!s.isNew){X(s,e,o);return}if(a){ee(e,o);return}if(s){l.info("Ese asiento ya lo tenés reservado.");return}oe(e,o)}S.addEventListener("click",e=>{const o=e.target.closest(".asiento");if(!o)return;const i=parseInt(o.dataset.mesa,10),t=parseInt(o.dataset.pos,10);Number.isNaN(i)||Number.isNaN(t)||ne(i,t)});N.addEventListener("click",async()=>{if(N.disabled)return;if(!O()){l.info("No hay cambios para confirmar.");return}const o=D();if(n.draft.length!==o){l.info(`Debés seleccionar ${o} asiento${o!==1?"s":""} antes de confirmar.`);return}const i=[];for(const t of n.draft){const s=t.cambios||0,a=t.id&&(t.mesa_id!==t.originalMesaId||t.posicion!==t.originalPosicion),d=t.id?s+(a?1:0):0;if(t.id&&a&&d>2){l.info("Ya alcanzaste el límite de 2 cambios para uno de tus asientos.");return}i.push({id:t.id,mesa_id:t.mesa_id,posicion:t.posicion,original_mesa_id:t.originalMesaId,original_posicion:t.originalPosicion,cambios:d})}try{l.loading("Confirmando selección...");const s=await H(F,{token:k,asientos:i}),a=JSON.parse(s||"{}");l.close(),l.success(a?.message||"¡Listo! Guardamos tu selección."),await $({showLoading:!0})}catch(t){console.error(t),l.close();try{const s=JSON.parse(t.message);l.error(s?.error||"No pudimos guardar tus asientos.")}catch{l.error(t.message||"No pudimos guardar tus asientos.")}await $({preserveDraft:!0})}});async function B(){if(n.realtimeSyncing){n.realtimeQueued=!0;return}n.realtimeSyncing=!0;try{await $({preserveDraft:!0})}finally{n.realtimeSyncing=!1,n.realtimeQueued&&(n.realtimeQueued=!1,B())}}function te(){if(n.realtimeChannel)return;const e=A.channel("mesa-asientos-changes").on("postgres_changes",{event:"*",schema:"public",table:"mesa_asientos"},()=>{B()}).subscribe();n.realtimeChannel=e}window.addEventListener("beforeunload",()=>{n.realtimeChannel?.unsubscribe()});async function ie(){await $({showLoading:!0,loadingMessage:"Cargando mesas..."}),te()}ie();
