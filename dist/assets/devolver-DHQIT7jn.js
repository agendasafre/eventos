import{S as r}from"./sweetalert2.esm.all-XZF9si33.js";import"./nav-BketaF_m.js";import{s as m}from"./supabase-CFADINa5.js";const d="4",w=sessionStorage.getItem("internal_key"),a=(e,t=document)=>t.querySelector(e),l=a("#dni"),u=a("#info"),f=a("#nombre"),c=a("#pulserasBox"),i=a("#pulseras"),s=a("#btnDevolver");function b(e){const t=document.createElement("span");return t.textContent=e,t.className="bg-celeste text-azuloscuro px-3 py-1 rounded-full font-medium shadow-sm",t}async function p(){if(w===d)return!0;const{value:e}=await r.fire({title:"Acceso restringido",input:"password",inputLabel:"Ingresá la clave de acceso",inputPlaceholder:"••••••",confirmButtonText:"Entrar",background:"#f1faee",color:"#1d3557",allowOutsideClick:!1});return e===d?(sessionStorage.setItem("internal_key",e),!0):(await r.fire({icon:"error",title:"Clave incorrecta",text:"No tenés autorización para acceder."}),p())}async function h(e){const{data:t,error:n}=await m.from("entradas").select("numero").eq("dni_titular",e).eq("entregado",!0).order("numero",{ascending:!0});return n?(console.error(n),[]):(t||[]).map(o=>o.numero)}function v(e){if(!e||e.length===0){i.innerHTML="",c.classList.add("hidden");return}i.innerHTML="",e.forEach(t=>i.appendChild(b(`#${t}`))),c.classList.remove("hidden")}async function y(){const e=l.value.trim();if(u.classList.add("hidden"),s.disabled=!0,c.classList.add("hidden"),i.innerHTML="",f.textContent="",!!e){r.showLoading();try{const{data:t,error:n}=await m.from("invitados").select("nombre, retiro, estado").eq("dni",e).maybeSingle();if(r.close(),n||!t){await r.fire({icon:"error",title:"DNI no encontrado"});return}f.textContent=t.nombre||"",u.classList.remove("hidden");const o=await h(e);if(v(o),o.length===0){await r.fire({icon:"info",title:"Sin pulseras entregadas",text:"Este DNI no tiene pulseras para devolver."}),s.disabled=!0;return}s.disabled=!1}catch(t){r.close(),console.error(t),await r.fire({icon:"error",title:"Error al buscar el DNI"})}}}async function E(){const e=l.value.trim();if(!e)return;const t="/api/devolver";try{r.showLoading();const n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dni:e})}),o=await n.json();if(r.close(),!n.ok)throw new Error(o?.error||"No se pudo registrar la devolución");v([]),s.disabled=!0,await r.fire({icon:"success",title:"Devolución registrada",html:`Se devolvieron: <b>${(o.numeros||[]).map(g=>`#${g}`).join(" ")}</b>`})}catch(n){r.close(),console.error(n),await r.fire({icon:"error",title:"Error",text:n.message||"No se pudo registrar la devolución"})}}a("#anio").textContent=new Date().getFullYear();(async()=>(await p(),l.addEventListener("blur",y),s.addEventListener("click",E)))();
