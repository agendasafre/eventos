import{s as P}from"./sweetalert2.esm.all-C9FIaYH4.js";import{u as t}from"./ui-D9-0gNA8.js";const q="/api/retirar",n=(o,e=document)=>e.querySelector(o),M=n("#form"),x=n("#dni"),s=n("#nombre"),l=n("#correo"),d=n("#comun"),v=n("#celiacos"),f=n("#vegetarianos"),p=n("#veganos"),N=n("#totalNum"),L=n("#pulserasContainer"),g=n("#listaPulseras"),C=n("#submitBtn"),w=n("#datosInvitado"),_=[s,l,d,v,f,p],T=[d,v,f,p];let i=null,c=!1;function $(){s.value="",l.value="",T.forEach(o=>{o.value="0"}),N.textContent="0",g.innerHTML="",L.classList.add("hidden")}function y({reset:o=!0}={}){w.classList.add("hidden"),_.forEach(e=>{e.disabled=!0}),C.disabled=!0,o&&$()}function j(){w.classList.remove("hidden"),_.forEach(o=>{o.disabled=!1}),I()}function F(){_.forEach(o=>{o.disabled=!0}),C.disabled=!0}const r=o=>Number.isNaN(parseInt(o,10))?0:parseInt(o,10);function b(){return r(d.value)+r(v.value)+r(f.value)+r(p.value)}function I(){const o=b();N.textContent=o,s.value.trim().length>0,l.value.trim().length>0,C.disabled=!c||s.disabled}function S(o){Array.isArray(o)&&(g.innerHTML="",o.forEach(e=>{const a=document.createElement("span");a.textContent=`#${e}`,a.className="bg-celeste text-azuloscuro px-3 py-1 rounded-full font-medium shadow-sm",g.appendChild(a)}),L.classList.remove("hidden"))}async function H(o,e=null){const a=P.from("entradas").select("numero").eq("dni_titular",o).eq("entregado",!0).order("numero",{ascending:!0}),{data:u,error:h}=e?await a.limit(e):await a;return h?(console.error(h),[]):(u||[]).map(m=>m.numero)}y();x.addEventListener("blur",async()=>{const o=x.value.trim();if(!o){i=null,c=!1,y();return}i=null,c=!1,y(),t.loading("Verificando DNI...");try{const{data:e,error:a}=await P.from("invitados").select("*").eq("dni",o).maybeSingle();if(t.close(),a||!e){t.error("DNI no encontrado o no habilitado.");return}if(i=e,e.retiro===!0){s.value=e.nombre||"",l.value=e.correo||"",d.value=r(e.opciones_comun),v.value=r(e.opciones_celiacos),f.value=r(e.opciones_vegetarianos),p.value=r(e.opciones_veganos),N.textContent=b(),F(),w.classList.remove("hidden"),t.info("Este invitado ya retiró sus entradas.");const u=await H(o);u.length&&S(u),i=null;return}if(e.estado!=="registrado"){t.info("El invitado no completó el registro."),i=null;return}s.value=e.nombre||"",l.value=e.correo||"",d.value=r(e.opciones_comun),v.value=r(e.opciones_celiacos),f.value=r(e.opciones_vegetarianos),p.value=r(e.opciones_veganos),L.classList.add("hidden"),g.innerHTML="",c=!0,j(),I(),t.success(`Invitado validado. Total de menús: ${b()}.`)}catch(e){t.close(),console.error(e),t.error("Error al verificar el DNI."),i=null,c=!1}});T.forEach(o=>{o.addEventListener("input",()=>{const e=r(o.value);o.value=e<0?"0":`${e}`,I()})});[s,l].forEach(o=>{o.addEventListener("input",I)});M.addEventListener("submit",async o=>{if(o.preventDefault(),!c||!i)return t.error("Validá primero el DNI.");const e=[],a=s.value.trim(),u=l.value.trim(),h=b();if(a||e.push("Completá el nombre."),u||e.push("Completá el correo."),h<1&&e.push("Seleccioná al menos un menú."),e.length){t.info(e.join(" ")),a?u?d.focus():l.focus():s.focus();return}try{t.loading("Registrando retiro...");const m={dni:i.dni,nombre:s.value.trim(),correo:l.value.trim(),comun:r(d.value),celiacos:r(v.value),vegetarianos:r(f.value),veganos:r(p.value)},D=await fetch(q,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)}),E=await D.json();if(!D.ok)throw new Error(E?.error||"Error en retiro");S(E.numeros),t.close(),t.success(E?.message||"Retiro registrado y correo enviado."),F(),c=!1,i.retiro=!0}catch(m){t.close(),console.error(m),t.error(m.message||"No se pudo registrar el retiro.")}});n("#anio").textContent=new Date().getFullYear();
