import{S as m}from"./sweetalert2.esm.all-D00jIjAz.js";import"./nav-BTX2NAH9.js";import{s as b}from"./supabase-CFADINa5.js";const w="4",L=sessionStorage.getItem("internal_key"),p=(e,n=document)=>n.querySelector(e),v=p("#tbody"),M=p("#totales"),d=p("#search"),$=p("#btnExportCsv");function i(e){const n=parseInt(e,10);return Number.isNaN(n)?0:n}async function S(e){if(!Array.isArray(e)||e.length===0)return new Map;const{data:n,error:a}=await b.from("entradas").select("dni_titular, numero").in("dni_titular",e).eq("entregado",!0);if(a)return console.error(a),new Map;const t=new Map;return(n||[]).forEach(({dni_titular:s,numero:o})=>{const r=String(s||""),c=t.get(r)||[];c.push(o),t.set(r,c)}),t.forEach(s=>s.sort((o,r)=>(o??0)-(r??0))),t}async function A(e){v.innerHTML="";const n=Array.from(new Set(e.map(t=>String(t.dni||"")).filter(Boolean))),a=await S(n);e.forEach(t=>{const s=document.createElement("tr");s.className="odd:bg-white even:bg-crema/30";const o=a.get(String(t.dni||""))||[],r=o.length?o.map(c=>`#${c}`).join(", "):"";s.innerHTML=`
      <td class="p-3 whitespace-nowrap text-azuloscuro">${t.dni??""}</td>
      <td class="p-3 text-azuloscuro">${t.nombre??""}</td>
      <td class="p-3 text-center text-azuloscuro font-semibold">${i(t.opciones)}</td>
      <td class="p-3 text-azuloscuro">${r}</td>
    `,v.appendChild(s)})}function k(e){const n=e.reduce((a,t)=>a+i(t.opciones),0);M.innerHTML=`
    <div class="flex flex-wrap gap-3 items-center">
      <span class="ml-auto">Total general: <b>${n}</b></span>
    </div>
  `}function _(e,n){const a=(n||"").trim().toLowerCase();return a?e.filter(t=>String(t.dni||"").toLowerCase().includes(a)||String(t.nombre||"").toLowerCase().includes(a)):e}function T(e,n){const t=[["dni","nombre","opciones_total","pulseras","importe_total","cuotas","importe_cuota","por_planilla","opciones_comun","opciones_celiacos","opciones_vegetarianos","opciones_veganos"].join(",")],s=o=>{const r=String(o??"").replaceAll('"','""');return/[",\n]/.test(r)?`"${r}"`:r};return e.forEach(o=>{const r=n?.get(String(o.dni||""))||[],c=r.length?r.map(C=>`#${C}`).join(" "):"",l=i(o.opciones),u=!!o.es_manual,f=l*(u?25e3:5e4),g=u?3:4,y=Math.round(f/g),E=u?"No":"Si",x=[o.dni||"",o.nombre||"",l,c,f,g,y,E,i(o.opciones_comun),i(o.opciones_celiacos),i(o.opciones_vegetarianos),i(o.opciones_veganos)];t.push(x.map(s).join(","))}),t.join(`
`)}async function j(){const{data:e,error:n}=await b.from("invitados").select("dni, nombre, opciones, opciones_comun, opciones_celiacos, opciones_vegetarianos, opciones_veganos, es_manual").eq("retiro",!0).order("dni",{ascending:!0});if(n)throw n;return e||[]}async function h(){if(L===w)return!0;const{value:e}=await m.fire({title:"Acceso restringido",input:"password",inputLabel:"Ingresá la clave de acceso",inputPlaceholder:"••••••",confirmButtonText:"Entrar",background:"#f1faee",color:"#1d3557",allowOutsideClick:!1});return e===w?(sessionStorage.setItem("internal_key",e),!0):(await m.fire({icon:"error",title:"Clave incorrecta",text:"No tenés autorización para acceder."}),h())}async function N(){p("#anio").textContent=new Date().getFullYear(),await h();try{let e=await j();const n=async()=>{const a=_(e,d.value||"");await A(a),k(a)};d.addEventListener("input",n),$.addEventListener("click",async()=>{const a=_(e,d.value||""),t=Array.from(new Set(a.map(u=>String(u.dni||"")).filter(Boolean))),s=await S(t),o=T(a,s),r=new Blob([o],{type:"text/csv;charset=utf-8;"}),c=URL.createObjectURL(r),l=document.createElement("a");l.href=c,l.download=`retirados_${new Date().toISOString().slice(0,10)}.csv`,l.click(),URL.revokeObjectURL(c)}),await n()}catch(e){console.error(e),await m.fire({icon:"error",title:"Error",text:"No se pudieron cargar los datos."})}}N();
