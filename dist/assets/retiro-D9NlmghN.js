import{u as r,s as p}from"./ui-Cf0ssn9_.js";import{p as L}from"./api-Ddpk_UT3.js";const P="/api/retirar",t=(o,e=document)=>e.querySelector(o),q=t("#form"),g=t("#dni"),x=t("#nombre"),A=t("#correo"),l=t("#comun"),u=t("#celiacos"),c=t("#vegetarianos"),d=t("#veganos"),V=t("#totalNum"),z=t("#pulserasContainer"),y=t("#listaPulseras"),b=t("#submitBtn");let f=null,i=!1,m=[];const a=o=>Number.isNaN(parseInt(o,10))?0:parseInt(o,10);function N(){return a(l.value)+a(u.value)+a(c.value)+a(d.value)}function E(){const o=N();V.textContent=o,b.disabled=!i||o<1}function w(o){y.innerHTML="",o.forEach(e=>{const n=document.createElement("span");n.textContent=`#${e}`,n.className="bg-celeste text-azuloscuro px-3 py-1 rounded-full font-medium shadow-sm",y.appendChild(n)}),z.classList.remove("hidden")}g.addEventListener("blur",async()=>{const o=g.value.trim();if(o){r.loading("Verificando DNI...");try{const{data:e,error:n}=await p.from("invitados").select("*").eq("dni",o).maybeSingle();if(r.close(),n||!e){i=!1,r.error("DNI no encontrado o no habilitado.");return}if(f=e,x.value=e.nombre||"",A.value=e.correo||"",!e.acepto_terminos){i=!1,r.info("El invitado no aceptó los términos."),I(!0);return}if(e.retiro===!0){i=!1,r.info("Este invitado ya retiró sus pulseras."),I(!0);const{data:s}=await p.from("entradas").select("numero").eq("dni_titular",o).order("numero");s?.length&&w(s.map(v=>v.numero));return}i=!0,[l,u,c,d].forEach(s=>s.removeAttribute("readonly")),l.value=e.opciones_comun||0,u.value=e.opciones_celiacos||0,c.value=e.opciones_vegetarianos||0,d.value=e.opciones_veganos||0,E(),r.success("DNI validado correctamente. Podés registrar el retiro.")}catch(e){r.close(),console.error(e),r.error("Error al verificar el DNI.")}}});function I(o=!0){[l,u,c,d,b].forEach(n=>{o?n.setAttribute("readonly",!0):n.removeAttribute("readonly")}),b.disabled=o}[l,u,c,d].forEach(o=>{o.addEventListener("input",E)});q.addEventListener("submit",async o=>{if(o.preventDefault(),!i||!f)return r.error("Validá primero el DNI.");const e=N();if(e<1)return r.info("El total de menús debe ser mayor a 0.");try{r.loading("Registrando retiro...");const{data:n,error:s}=await p.from("entradas").select("numero").eq("entregado",!1).order("numero",{ascending:!0}).limit(e);if(s)throw s;if(m=(n||[]).map(C=>C.numero),!m.length)return r.close(),r.info("No hay pulseras disponibles.");const{error:v}=await p.from("invitados").update({retiro:!0,opciones_comun:a(l.value),opciones_celiacos:a(u.value),opciones_vegetarianos:a(c.value),opciones_veganos:a(d.value)}).eq("id",f.id);if(v)throw v;const{error:h}=await p.from("entradas").update({entregado:!0,dni_titular:f.dni}).in("numero",m);if(h)throw h;w(m);const _={invitado:f,numeros:m,comun:a(l.value),celiacos:a(u.value),vegetarianos:a(c.value),veganos:a(d.value),total:e},D=await L(P,_);r.close(),r.success("Retiro registrado y correo enviado."),console.log("Correo:",D),I(!0),i=!1}catch(n){r.close(),console.error(n),r.error("No se pudo registrar el retiro.")}});t("#anio").textContent=new Date().getFullYear();g.focus();
