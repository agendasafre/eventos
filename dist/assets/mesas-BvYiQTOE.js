import{s as N}from"./sweetalert2.esm.all-CxBOCMw6.js";import{u as i}from"./ui-DhUhkCgn.js";import{p as R}from"./api-Ddpk_UT3.js";const w=(n,e=document)=>e.querySelector(n),x=w("#mesasContainer"),p=w("#confirmBtn");w("#anio").textContent=new Date().getFullYear();const q="/api/confirmar",P=new URLSearchParams(window.location.search).get("token");if(!P)throw i.error("No se encontró el token de acceso."),new Error("Token faltante");i.loading("Cargando mesas...");let o={invitado:null,mesas:[],confirmed:[],draft:[],pendingMove:null,draftCounter:0,realtimeChannel:null};const E=(n,e)=>`${n}:${e}`;function M(){const n=o.invitado||{};return(n.opciones_comun||0)+(n.opciones_celiacos||0)+(n.opciones_vegetarianos||0)+(n.opciones_veganos||0)}function z(){o.draft=o.confirmed.map(n=>({...n,clientId:`seat-${n.id}`,originalMesaId:n.mesa_id,originalPosicion:n.posicion,isNew:!1,isMoved:!1,proposedCambios:n.cambios})),o.pendingMove=null,k()}function j(){const n=new Map;return o.draft.forEach(e=>{e.mesa_id&&e.posicion&&n.set(E(e.mesa_id,e.posicion),e)}),n}function C(){if(o.draft.length!==o.confirmed.length)return!0;const n=new Map;o.confirmed.forEach(e=>n.set(e.id,e));for(const e of o.draft){if(!e.id)return!0;const t=n.get(e.id);if(!t||e.mesa_id!==t.mesa_id||e.posicion!==t.posicion||(e.proposedCambios||e.cambios)!==t.cambios)return!0}return!1}function F(){return o.draft.length!==M()}function k(){const n=C(),e=F();if(!n||e){p.classList.add("hidden"),p.disabled=!0;return}p.classList.remove("hidden"),p.disabled=!1}function K(){const n=M(),e=o.draft.length,t=Math.max(n-e,0),a=C()?'<span class="text-orange-500 font-semibold">Tenés cambios sin confirmar.</span>':'<span class="text-green-600 font-semibold">Todo guardado.</span>',r=`
    <div class="mb-6 text-center bg-white/90 p-4 rounded-xl shadow">
      <p class="text-azuloscuro font-semibold">
        Tenés <b>${n}</b> asiento${n!==1?"s":""} disponible${n!==1?"s":""}.
      </p>
      <p class="text-sm text-gray-600">
        Seleccionaste ${e}, te quedan ${t}.
      </p>
      <p class="text-xs text-gray-500 mt-1">
        Podés cambiar cada asiento hasta <b>2 veces</b>.
      </p>
      <p class="text-xs mt-2">${a}</p>
    </div>
  `;w("#estadoAsientos")?.remove();const f=document.createElement("div");f.id="estadoAsientos",f.innerHTML=r,x.before(f)}function Y(n,e){o.mesas=n||[],o.confirmed=[];for(const t of o.mesas){const s=t.mesa_asientos||[];for(const a of s)a?.invitado_id===e&&o.confirmed.push({id:a.id,mesa_id:t.id,posicion:a.posicion,cambios:a.cambios||0})}z()}async function S({showLoading:n=!1}={}){try{n&&i.loading("Actualizando mesas...");const{data:e,error:t}=await N.from("invitados").select("*").eq("mesa_token",P).maybeSingle();if(t||!e)throw new Error("Token inválido");o.invitado=e;const{data:s,error:a}=await N.from("mesas").select(`
        id,
        numero,
        capacidad,
        mesa_asientos (
          id,
          posicion,
          invitado_id,
          cambios,
          invitados ( nombre )
        )
      `).order("numero",{ascending:!0});if(a)throw a;Y(s,e.id),b()}catch(e){console.error(e),i.error("Error al cargar las mesas.")}finally{i.close()}}function J(){x.innerHTML="";const n=j(),e=o.pendingMove?E(o.pendingMove.fromMesaId,o.pendingMove.fromPosicion):null;o.mesas.forEach(t=>{const s=document.createElement("div");s.className="bg-white/90 rounded-2xl shadow-md p-5 flex flex-col items-center text-center transition-transform hover:scale-105 m-2";const a=document.createElement("h2");a.className="text-azuloscuro font-bold mb-4",a.textContent=`Mesa ${t.numero}`,s.appendChild(a);const r=document.createElement("div");r.className="grid grid-cols-4 gap-3";const f=t.capacidad||8;for(let c=1;c<=f;c+=1){const m=(t.mesa_asientos||[]).find(H=>H.posicion===c)||null,T=E(t.id,c),_=n.get(T),O=m?.invitado_id&&m.invitado_id!==o.invitado.id,I=!!m&&m.invitado_id===o.invitado.id,A=!!_,$=_?.isNew||_?.isMoved,B=e===T,d=document.createElement("button");d.dataset.mesa=t.id,d.dataset.pos=c,d.className="asiento w-12 h-12 rounded-full flex items-center justify-center transition border";const l=document.createElement("i");l.classList.add("fa-solid");let g="Disponible",u="Disponible",v="text-transparent";O?(d.classList.add("bg-rojo","text-white","cursor-not-allowed"),d.disabled=!0,l.classList.add("fa-user-slash"),g=m?.invitados?.nombre||"Ocupado",u=m?.invitados?.nombre||"Ocupado",v="text-gray-800"):A?(d.classList.add("border-4","border-emerald-400","bg-emerald-50"),l.classList.add("fa-star","text-emerald-500"),g=$?"Nuevo asiento seleccionado":"Tu asiento",u=$?"Nuevo":"Confirmado",v="text-emerald-600"):B&&I?(d.classList.add("border","border-dashed","border-amber-400","bg-amber-50"),l.classList.add("fa-person-walking-arrow-right"),g="Liberado para mover",u="Moverás este asiento",v="text-amber-500"):I?(d.classList.add("border-4","border-yellow-400","bg-yellow-50"),l.classList.add("fa-star","text-yellow-400"),g="Tu asiento actual",u="Actual",v="text-yellow-500"):(d.classList.add("border","border-celeste","hover:border-azuloscuro","hover:bg-celeste/20"),l.classList.add("fa-chair","text-amber-800")),d.title=g,d.appendChild(l);const h=document.createElement("div");h.className="flex flex-col items-center justify-center text-center",h.appendChild(d);const y=document.createElement("p");y.className=`text-sm mt-1 max-w-[120px] leading-tight ${v}`,y.textContent=u==="Disponible"?".":u,h.appendChild(y),r.appendChild(h)}s.appendChild(r),x.appendChild(s)})}function b(){K(),J(),k()}function D(n,e){return o.draft.find(t=>t.mesa_id===n&&t.posicion===e)}function U(n){return o.draft.find(e=>e.clientId===n)}function G(n,e,t){if(o.pendingMove){i.info("Primero ubicá el asiento que ya estás moviendo.");return}if(n.cambios>=2){i.info("No podés cambiar este asiento más de 2 veces.");return}o.pendingMove={clientId:n.clientId,fromMesaId:e,fromPosicion:t},b(),i.info("Elegí el nuevo lugar para este asiento.")}function L(){o.pendingMove=null,b()}function V(n){o.draft=o.draft.filter(e=>e.clientId!==n.clientId),b()}function Q(n,e){const t=o.pendingMove;if(!t)return;const s=U(t.clientId);if(!s){L();return}const a=(s.cambios||0)+1;if(a>2){i.info("No podés cambiar este asiento más de 2 veces."),L();return}if(D(n,e)){i.info("Ya seleccionaste ese lugar. Elegí otro.");return}s.mesa_id=n,s.posicion=e,s.isMoved=!0,s.proposedCambios=a,o.pendingMove=null,b()}function W(n,e){const t=M();if(o.draft.length>=t){i.info("Ya seleccionaste todos tus asientos disponibles.");return}o.draftCounter+=1,o.draft.push({id:null,mesa_id:n,posicion:e,cambios:0,proposedCambios:0,isNew:!0,isMoved:!1,originalMesaId:null,originalPosicion:null,clientId:`new-${o.draftCounter}`}),b()}function X(n,e){const t=o.mesas.find(c=>c.id===n);if(!t)return;const s=(t.mesa_asientos||[]).find(c=>c.posicion===e)||null,a=D(n,e),r=o.pendingMove;if(s?.invitado_id&&s.invitado_id!==o.invitado.id){i.info("Ese asiento ya está ocupado.");return}if(a&&a.isNew){V(a);return}if(r&&r.fromMesaId===n&&r.fromPosicion===e){L();return}if(a&&!a.isNew){G(a,n,e);return}if(r){Q(n,e);return}if(a){i.info("Ese asiento ya lo tenés reservado.");return}W(n,e)}x.addEventListener("click",n=>{const e=n.target.closest(".asiento");if(!e)return;const t=parseInt(e.dataset.mesa,10),s=parseInt(e.dataset.pos,10);Number.isNaN(t)||Number.isNaN(s)||X(t,s)});p.addEventListener("click",async()=>{if(p.disabled)return;if(!C()){i.info("No hay cambios para confirmar.");return}const e=M();if(o.draft.length!==e){i.info(`Debés seleccionar ${e} asiento${e!==1?"s":""} antes de confirmar.`);return}try{i.loading("Confirmando selección...");const t={token:P,asientos:o.draft.map(r=>({id:r.id,mesa_id:r.mesa_id,posicion:r.posicion,original_mesa_id:r.originalMesaId,original_posicion:r.originalPosicion,cambios:r.proposedCambios??r.cambios}))},s=await R(q,t),a=JSON.parse(s||"{}");i.close(),i.success(a?.message||"¡Listo! Guardamos tu selección."),await S({showLoading:!0})}catch(t){console.error(t),i.close();try{const s=JSON.parse(t.message);i.error(s?.error||"No pudimos guardar tus asientos.")}catch{i.error(t.message||"No pudimos guardar tus asientos.")}}});async function Z(){C()||await S()}function ee(){if(o.realtimeChannel)return;const n=N.channel("mesa-asientos-changes").on("postgres_changes",{event:"*",schema:"public",table:"mesa_asientos"},()=>{Z()}).subscribe();o.realtimeChannel=n}window.addEventListener("beforeunload",()=>{o.realtimeChannel?.unsubscribe()});async function ne(){await S(),ee()}ne();
