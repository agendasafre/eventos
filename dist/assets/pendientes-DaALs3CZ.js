import{S as l}from"./sweetalert2.esm.all-Cl5o7qez.js";import{s as h}from"./supabase-CFADINa5.js";const g="555255",S=sessionStorage.getItem("internal_key"),f=(e,t=document)=>t.querySelector(e),m=f("#tbody"),y=f("#totales"),v=f("#search"),E=f("#btnExport");function r(e){const t=parseInt(e,10);return Number.isNaN(t)?0:t}function x(e){return r(e.opciones_comun)+r(e.opciones_celiacos)+r(e.opciones_vegetarianos)+r(e.opciones_veganos)}function C(e){m.innerHTML="",e.forEach(t=>{const n=document.createElement("tr");n.className="odd:bg-white even:bg-crema/30",n.innerHTML=`
      <td class="p-3 whitespace-nowrap text-azuloscuro">${t.dni||""}</td>
      <td class="p-3 text-azuloscuro">${t.nombre||""}</td>
      <td class="p-3 text-azuloscuro">${t.correo||""}</td>
      <td class="p-3 text-azuloscuro">${t.lugar_trabajo||""}</td>
      <td class="p-3 text-center text-azuloscuro">${r(t.opciones_comun)}</td>
      <td class="p-3 text-center text-azuloscuro">${r(t.opciones_celiacos)}</td>
      <td class="p-3 text-center text-azuloscuro">${r(t.opciones_vegetarianos)}</td>
      <td class="p-3 text-center text-azuloscuro">${r(t.opciones_veganos)}</td>
      <td class="p-3 text-center font-semibold text-azuloscuro">${x(t)}</td>
      <td class="p-3 text-center flex gap-2 justify-center">
        <button class="btnEditEmail bg-yellow-500 text-white px-3 py-1 rounded-md hover:bg-yellow-600" data-dni="${t.dni||""}" data-correo="${t.correo||""}">Editar correo</button>
        <button class="btnResend bg-azuloscuro text-white px-3 py-1 rounded-md hover:bg-azul" data-dni="${t.dni||""}" data-correo="${t.correo||""}">Reenviar</button>
      </td>
    `,m.appendChild(n)})}function $(e){const t=e.reduce((s,a)=>s+r(a.opciones_comun),0),n=e.reduce((s,a)=>s+r(a.opciones_celiacos),0),o=e.reduce((s,a)=>s+r(a.opciones_vegetarianos),0),c=e.reduce((s,a)=>s+r(a.opciones_veganos),0),p=t+n+o+c;y.innerHTML=`
    <div class="flex flex-wrap gap-3 items-center">
      <span>Total Común: <b>${t}</b></span>
      <span>· Celíacos: <b>${n}</b></span>
      <span>· Vegetarianos: <b>${o}</b></span>
      <span>· Veganos: <b>${c}</b></span>
      <span class="ml-auto">Total general: <b>${p}</b></span>
    </div>
  `}function z(e){const n=[["dni","nombre","correo","lugar_trabajo","opciones_comun","opciones_celiacos","opciones_vegetarianos","opciones_veganos","total"].join(",")];return e.forEach(o=>{const c=[o.dni||"",o.nombre||"",o.correo||"",o.lugar_trabajo||"",r(o.opciones_comun),r(o.opciones_celiacos),r(o.opciones_vegetarianos),r(o.opciones_veganos),x(o)],p=s=>{const a=String(s).replaceAll('"','""');return/[",\n]/.test(a)?`"${a}"`:a};n.push(c.map(p).join(","))}),n.join(`
`)}function L(e,t){const n=new Blob([t],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(n),c=document.createElement("a");c.href=o,c.download=e,c.click(),URL.revokeObjectURL(o)}function w(e,t){const n=t.trim().toLowerCase();return n?e.filter(o=>String(o.dni||"").toLowerCase().includes(n)||String(o.nombre||"").toLowerCase().includes(n)||String(o.correo||"").toLowerCase().includes(n)):e}async function T(){const{data:e,error:t}=await h.from("invitados").select("dni, nombre, correo, lugar_trabajo, estado, retiro, opciones, opciones_comun, opciones_celiacos, opciones_vegetarianos, opciones_veganos").eq("estado","registrado").or("retiro.is.false,retiro.is.null").gt("opciones",0).order("dni",{ascending:!0});if(t)throw t;return e||[]}async function _(){if(S===g)return!0;const{value:e}=await l.fire({title:"Acceso restringido",input:"password",inputLabel:"Ingresá la clave de acceso",inputPlaceholder:"••••••",confirmButtonText:"Entrar",background:"#f1faee",color:"#1d3557",allowOutsideClick:!1});return e===g?(sessionStorage.setItem("internal_key",e),!0):(await l.fire({icon:"error",title:"Clave incorrecta",text:"No tenés autorización para acceder."}),_())}async function j(){f("#anio").textContent=new Date().getFullYear(),await _();try{let e=await T();const t=()=>{const n=w(e,v.value||"");C(n),$(n)};m.addEventListener("click",async n=>{const o=n.target.closest(".btnResend"),c=n.target.closest(".btnEditEmail");if(!o&&!c)return;const p=o||c,s=p.getAttribute("data-dni"),a=p.getAttribute("data-correo")||"";if(c){const{value:d}=await l.fire({title:"Editar correo",input:"email",inputLabel:"Nuevo correo del invitado",inputValue:a,confirmButtonText:"Guardar",showCancelButton:!0,inputValidator:i=>/\S+@\S+\.\S+/.test(i)?void 0:"Ingresá un correo válido"});if(!d||d===a)return;try{const i=await fetch("/api/actualizar-correo",{method:"POST",headers:{"Content-Type":"application/json",...g?{"x-internal-key":g}:{}},body:JSON.stringify({dni:s,correo:d})}),b=await i.json();if(!i.ok)throw new Error(b?.error||"No se pudo actualizar");await l.fire({icon:"success",title:"Actualizado",text:"Correo actualizado."}),e=e.map(u=>String(u.dni)===String(s)?{...u,correo:d}:u),t()}catch(i){console.error(i),await l.fire({icon:"error",title:"Error",text:i.message||"Falló la actualización"})}return}if(o){const{value:d}=await l.fire({title:"Reenviar correo de registro",input:"email",inputLabel:"Correo del invitado",inputValue:a,confirmButtonText:"Reenviar",showCancelButton:!0,inputValidator:i=>/\S+@\S+\.\S+/.test(i)?void 0:"Ingresá un correo válido"});if(!d)return;try{const i=await fetch("/api/reenviar",{method:"POST",headers:{"Content-Type":"application/json",...g?{"x-internal-key":g}:{}},body:JSON.stringify({tipo:"registro",dni:s,correo:d})}),b=await i.json();if(!i.ok)throw new Error(b?.error||"No se pudo reenviar");await l.fire({icon:"success",title:"Enviado",text:"Correo reenviado correctamente."}),e=e.map(u=>String(u.dni)===String(s)?{...u,correo:d}:u),t()}catch(i){console.error(i),await l.fire({icon:"error",title:"Error",text:i.message||"Falló el reenvío"})}}}),v.addEventListener("input",t),E.addEventListener("click",()=>{const n=w(e,v.value||""),o=z(n);L(`pendientes_retiro_${new Date().toISOString().slice(0,10)}.csv`,o)}),t()}catch(e){console.error(e),await l.fire({icon:"error",title:"Error",text:"No se pudieron cargar los datos."})}}j();
