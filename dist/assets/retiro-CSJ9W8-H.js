import{u as o,s as I}from"./ui-Cf0ssn9_.js";import{p as w}from"./api-Ddpk_UT3.js";const P="/api/retirar",n=(e,t=document)=>t.querySelector(e),C=n("#form"),g=n("#dni"),_=n("#nombre"),q=n("#correo"),l=n("#comun"),c=n("#celiacos"),d=n("#vegetarianos"),m=n("#veganos"),x=n("#totalNum"),L=n("#pulserasContainer"),b=n("#listaPulseras"),y=n("#submitBtn");let f=null,i=!1;const a=e=>Number.isNaN(parseInt(e,10))?0:parseInt(e,10);function p(){return a(l.value)+a(c.value)+a(d.value)+a(m.value)}function u(e=!0){[l,c,d,m].forEach(r=>{e?r.setAttribute("readonly",!0):r.removeAttribute("readonly")}),y.disabled=e||p()<1}function N(){const e=p();x.textContent=e,y.disabled=!i||e<1}function E(e){Array.isArray(e)&&(b.innerHTML="",e.forEach(t=>{const r=document.createElement("span");r.textContent=`#${t}`,r.className="bg-celeste text-azuloscuro px-3 py-1 rounded-full font-medium shadow-sm",b.appendChild(r)}),L.classList.remove("hidden"))}async function h(e,t=null){const r=I.from("entradas").select("numero").eq("dni_titular",e).eq("entregado",!0).order("numero",{ascending:!0}),{data:s,error:v}=t?await r.limit(t):await r;return v?(console.error(v),[]):(s||[]).map(D=>D.numero)}g.addEventListener("blur",async()=>{const e=g.value.trim();if(e){o.loading("Verificando DNI...");try{const{data:t,error:r}=await I.from("invitados").select("*").eq("dni",e).maybeSingle();if(o.close(),r||!t){i=!1,o.error("DNI no encontrado o no habilitado."),u(!0);return}if(f=t,_.value=t.nombre||"",q.value=t.correo||"",!t.acepto_terminos){i=!1,o.info("El invitado no aceptó los términos."),u(!0);return}if(t.retiro===!0){i=!1,o.info("Este invitado ya retiró sus pulseras."),u(!0);const s=await h(e);s.length&&E(s);return}l.value=t.opciones_comun||0,c.value=t.opciones_celiacos||0,d.value=t.opciones_vegetarianos||0,m.value=t.opciones_veganos||0,i=!0,u(!1),N(),o.success("DNI validado. Podés registrar el retiro.")}catch(t){o.close(),console.error(t),o.error("Error al verificar el DNI."),u(!0)}}});[l,c,d,m].forEach(e=>{e.addEventListener("input",N)});C.addEventListener("submit",async e=>{if(e.preventDefault(),!i||!f)return o.error("Validá primero el DNI.");const t=p();if(t<1)return o.info("El total de menús debe ser mayor a 0.");try{o.loading("Registrando retiro...");const r={dni:f.dni,comun:a(l.value),celiacos:a(c.value),vegetarianos:a(d.value),veganos:a(m.value)};await w(P,r);const s=await h(f.dni,t);s.length&&E(s),o.close(),o.success("Retiro registrado y correo enviado."),u(!0),i=!1}catch(r){o.close(),console.error(r),o.error("No se pudo registrar el retiro.")}});n("#anio").textContent=new Date().getFullYear();
