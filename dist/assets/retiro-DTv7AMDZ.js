import{u as o,s as f}from"./ui-Cf0ssn9_.js";import{p as L}from"./api-Ddpk_UT3.js";const P="/api/retirar",t=(r,e=document)=>e.querySelector(r),q=t("#form"),h=t("#dni"),x=t("#nombre"),A=t("#correo"),l=t("#comun"),u=t("#celiacos"),c=t("#vegetarianos"),d=t("#veganos"),V=t("#totalNum"),z=t("#pulserasContainer"),y=t("#listaPulseras"),g=t("#submitBtn");let p=null,i=!1,m=[];const a=r=>Number.isNaN(parseInt(r,10))?0:parseInt(r,10);function N(){return a(l.value)+a(u.value)+a(c.value)+a(d.value)}function E(){const r=N();V.textContent=r,g.disabled=!i||r<1}function w(r){y.innerHTML="",r.forEach(e=>{const n=document.createElement("span");n.textContent=`#${e}`,n.className="bg-celeste text-azuloscuro px-3 py-1 rounded-full font-medium shadow-sm",y.appendChild(n)}),z.classList.remove("hidden")}h.addEventListener("blur",async()=>{const r=h.value.trim();if(r){o.loading("Verificando DNI...");try{const{data:e,error:n}=await f.from("invitados").select("*").eq("dni",r).maybeSingle();if(o.close(),n||!e){i=!1,o.error("DNI no encontrado o no habilitado.");return}if(p=e,x.value=e.nombre||"",A.value=e.correo||"",!e.acepto_terminos){i=!1,o.info("El invitado no aceptó los términos."),b(!0);return}if(e.retiro===!0){i=!1,o.info("Este invitado ya retiró sus pulseras."),b(!0);const{data:s}=await f.from("entradas").select("numero").eq("dni_titular",r).order("numero");s?.length&&w(s.map(v=>v.numero));return}i=!0,[l,u,c,d].forEach(s=>s.removeAttribute("readonly")),l.value=e.opciones_comun||0,u.value=e.opciones_celiacos||0,c.value=e.opciones_vegetarianos||0,d.value=e.opciones_veganos||0,E(),o.success("DNI validado correctamente. Podés registrar el retiro.")}catch(e){o.close(),console.error(e),o.error("Error al verificar el DNI.")}}});function b(r=!0){[l,u,c,d,g].forEach(n=>{r?n.setAttribute("readonly",!0):n.removeAttribute("readonly")}),g.disabled=r}[l,u,c,d].forEach(r=>{r.addEventListener("input",E)});q.addEventListener("submit",async r=>{if(r.preventDefault(),!i||!p)return o.error("Validá primero el DNI.");const e=N();if(e<1)return o.info("El total de menús debe ser mayor a 0.");try{o.loading("Registrando retiro...");const{data:n,error:s}=await f.from("entradas").select("numero").eq("entregado",!1).order("numero",{ascending:!0}).limit(e);if(s)throw s;if(m=(n||[]).map(C=>C.numero),!m.length)return o.close(),o.info("No hay pulseras disponibles.");const{error:v}=await f.from("invitados").update({retiro:!0,opciones_comun:a(l.value),opciones_celiacos:a(u.value),opciones_vegetarianos:a(c.value),opciones_veganos:a(d.value)}).eq("id",p.id);if(v)throw v;const{error:I}=await f.from("entradas").update({entregado:!0,dni_titular:p.dni}).in("numero",m);if(I)throw I;w(m);const _={invitado:p,numeros:m,comun:a(l.value),celiacos:a(u.value),vegetarianos:a(c.value),veganos:a(d.value),total:e},D=await L(P,_);o.close(),o.success("Retiro registrado y correo enviado."),console.log("Correo:",D),b(!0),i=!1}catch(n){o.close(),console.error(n),o.error("No se pudo registrar el retiro.")}});t("#anio").textContent=new Date().getFullYear();
