import{u as r,s as h}from"./ui-Cf0ssn9_.js";const D="/api/retirar",n=(e,t=document)=>t.querySelector(e),C=n("#form"),b=n("#dni"),P=n("#nombre"),_=n("#correo"),u=n("#comun"),d=n("#celiacos"),m=n("#vegetarianos"),f=n("#veganos"),x=n("#totalNum"),i=n("#pulserasContainer"),y=n("#listaPulseras"),I=n("#submitBtn");let v=null,s=!1;const a=e=>Number.isNaN(parseInt(e,10))?0:parseInt(e,10);function g(){return a(u.value)+a(d.value)+a(m.value)+a(f.value)}function l(e=!0){[u,d,m,f].forEach(o=>{e?o.setAttribute("readonly",!0):o.removeAttribute("readonly")}),I.disabled=e||g()<1}function N(){const e=g();x.textContent=e,I.disabled=!s||e<1}function E(e){Array.isArray(e)&&(y.innerHTML="",e.forEach(t=>{const o=document.createElement("span");o.textContent=`#${t}`,o.className="bg-celeste text-azuloscuro px-3 py-1 rounded-full font-medium shadow-sm",y.appendChild(o)}),i.classList.remove("hidden"))}b.addEventListener("blur",async()=>{const e=b.value.trim();if(e){r.loading("Verificando DNI...");try{const{data:t,error:o}=await h.from("invitados").select("*").eq("dni",e).maybeSingle();if(r.close(),o||!t){s=!1,r.error("DNI no encontrado o no habilitado."),l(!0),i.classList.add("hidden");return}if(v=t,P.value=t.nombre||"",_.value=t.correo||"",!t.acepto_terminos){s=!1,r.info("El invitado no aceptó los términos."),l(!0),i.classList.add("hidden");return}if(t.retiro===!0){s=!1,r.info("Este invitado ya retiró sus entradas."),l(!0);const{data:c,error:p}=await h.from("entradas").select("numero").eq("dni_titular",e).eq("entregado",!0).order("numero",{ascending:!0});if(!p&&c?.length){const L=c.map(w=>w.numero);E(L)}else i.classList.add("hidden");return}u.value=t.opciones_comun||0,d.value=t.opciones_celiacos||0,m.value=t.opciones_vegetarianos||0,f.value=t.opciones_veganos||0,s=!0,l(!1),N(),r.success("DNI validado. Podés registrar el retiro."),i.classList.add("hidden")}catch(t){r.close(),console.error(t),r.error("Error al verificar el DNI."),l(!0),i.classList.add("hidden")}}});[u,d,m,f].forEach(e=>{e.addEventListener("input",N)});C.addEventListener("submit",async e=>{if(e.preventDefault(),!s||!v)return r.error("Validá primero el DNI.");if(g()<1)return r.info("El total de menús debe ser mayor a 0.");try{r.loading("Registrando retiro...");const o={dni:v.dni,comun:a(u.value),celiacos:a(d.value),vegetarianos:a(m.value),veganos:a(f.value)},c=await fetch(D,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),p=await c.json();if(!c.ok)throw new Error(p?.error||"Error en retiro");E(p.numeros),r.close(),r.success("Retiro registrado y correo enviado."),l(!0),s=!1}catch(o){r.close(),console.error(o),r.error(o.message||"No se pudo registrar el retiro.")}});n("#anio").textContent=new Date().getFullYear();
