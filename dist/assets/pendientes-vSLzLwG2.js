import{S as i}from"./sweetalert2.esm.all-D00jIjAz.js";import"./nav-BTX2NAH9.js";import{s as _}from"./supabase-CFADINa5.js";const u="555255",x=sessionStorage.getItem("internal_key"),d=(e,t=document)=>t.querySelector(e),f=d("#tbody"),h=d("#totales"),g=d("#search"),C=d("#btnExport");function a(e){const t=parseInt(e,10);return Number.isNaN(t)?0:t}function v(e){return a(e.opciones_comun)+a(e.opciones_celiacos)+a(e.opciones_vegetarianos)+a(e.opciones_veganos)}function S(e){f.innerHTML="",e.forEach(t=>{const n=document.createElement("tr");n.className="odd:bg-white even:bg-crema/30",n.innerHTML=`
      <td class="p-3 whitespace-nowrap text-azuloscuro">${t.dni||""}</td>
      <td class="p-3 text-azuloscuro">${t.nombre||""}</td>
      <td class="p-3 text-azuloscuro">${t.correo||""}</td>
      <td class="p-3 text-azuloscuro">${t.lugar_trabajo||""}</td>
      <td class="p-3 text-center text-azuloscuro">${a(t.opciones_comun)}</td>
      <td class="p-3 text-center text-azuloscuro">${a(t.opciones_celiacos)}</td>
      <td class="p-3 text-center text-azuloscuro">${a(t.opciones_vegetarianos)}</td>
      <td class="p-3 text-center text-azuloscuro">${a(t.opciones_veganos)}</td>
      <td class="p-3 text-center font-semibold text-azuloscuro">${v(t)}</td>
      <td class="p-3 text-center">
        <button class="btnResend bg-azuloscuro text-white px-3 py-1 rounded-md hover:bg-azul" data-dni="${t.dni||""}" data-correo="${t.correo||""}">Reenviar</button>
      </td>
    `,f.appendChild(n)})}function y(e){const t=e.reduce((s,r)=>s+a(r.opciones_comun),0),n=e.reduce((s,r)=>s+a(r.opciones_celiacos),0),o=e.reduce((s,r)=>s+a(r.opciones_vegetarianos),0),c=e.reduce((s,r)=>s+a(r.opciones_veganos),0),l=t+n+o+c;h.innerHTML=`
    <div class="flex flex-wrap gap-3 items-center">
      <span>Total Común: <b>${t}</b></span>
      <span>· Celíacos: <b>${n}</b></span>
      <span>· Vegetarianos: <b>${o}</b></span>
      <span>· Veganos: <b>${c}</b></span>
      <span class="ml-auto">Total general: <b>${l}</b></span>
    </div>
  `}function $(e){const n=[["dni","nombre","correo","lugar_trabajo","opciones_comun","opciones_celiacos","opciones_vegetarianos","opciones_veganos","total"].join(",")];return e.forEach(o=>{const c=[o.dni||"",o.nombre||"",o.correo||"",o.lugar_trabajo||"",a(o.opciones_comun),a(o.opciones_celiacos),a(o.opciones_vegetarianos),a(o.opciones_veganos),v(o)],l=s=>{const r=String(s).replaceAll('"','""');return/[",\n]/.test(r)?`"${r}"`:r};n.push(c.map(l).join(","))}),n.join(`
`)}function E(e,t){const n=new Blob([t],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(n),c=document.createElement("a");c.href=o,c.download=e,c.click(),URL.revokeObjectURL(o)}function b(e,t){const n=t.trim().toLowerCase();return n?e.filter(o=>String(o.dni||"").toLowerCase().includes(n)||String(o.nombre||"").toLowerCase().includes(n)||String(o.correo||"").toLowerCase().includes(n)):e}async function L(){const{data:e,error:t}=await _.from("invitados").select("dni, nombre, correo, lugar_trabajo, estado, retiro, opciones, opciones_comun, opciones_celiacos, opciones_vegetarianos, opciones_veganos").eq("estado","registrado").or("retiro.is.false,retiro.is.null").gt("opciones",0).order("dni",{ascending:!0});if(t)throw t;return e||[]}async function m(){if(x===u)return!0;const{value:e}=await i.fire({title:"Acceso restringido",input:"password",inputLabel:"Ingresá la clave de acceso",inputPlaceholder:"••••••",confirmButtonText:"Entrar",background:"#f1faee",color:"#1d3557",allowOutsideClick:!1});return e===u?(sessionStorage.setItem("internal_key",e),!0):(await i.fire({icon:"error",title:"Clave incorrecta",text:"No tenés autorización para acceder."}),m())}async function z(){d("#anio").textContent=new Date().getFullYear(),await m();try{let e=await L();const t=()=>{const n=b(e,g.value||"");S(n),y(n)};f.addEventListener("click",async n=>{const o=n.target.closest(".btnResend");if(!o)return;const c=o.getAttribute("data-dni"),l=o.getAttribute("data-correo")||"",{value:s}=await i.fire({title:"Reenviar correo de registro",input:"email",inputLabel:"Correo del invitado",inputValue:l,confirmButtonText:"Reenviar",showCancelButton:!0,inputValidator:r=>/\S+@\S+\.\S+/.test(r)?void 0:"Ingresá un correo válido"});if(s)try{i.fire({title:"Reenviando correo…",text:"Por favor, esperá un momento.",allowOutsideClick:!1,didOpen:()=>{i.showLoading()}});const r=await fetch("/api/reenviar",{method:"POST",headers:{"Content-Type":"application/json",...u?{"x-internal-key":u}:{}},body:JSON.stringify({tipo:"registro",dni:c,correo:s})}),w=await r.json();if(!r.ok)throw new Error(w?.error||"No se pudo reenviar");i.close(),await i.fire({icon:"success",title:"Enviado",text:"Correo reenviado correctamente."}),e=e.map(p=>String(p.dni)===String(c)?{...p,correo:s}:p),t()}catch(r){i.close(),console.error(r),await i.fire({icon:"error",title:"Error",text:r.message||"Falló el reenvío"})}}),g.addEventListener("input",t),C.addEventListener("click",()=>{const n=b(e,g.value||""),o=$(n);E(`pendientes_retiro_${new Date().toISOString().slice(0,10)}.csv`,o)}),t()}catch(e){console.error(e),await i.fire({icon:"error",title:"Error",text:"No se pudieron cargar los datos."})}}z();
