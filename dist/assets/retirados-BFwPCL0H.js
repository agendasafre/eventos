import{S as p}from"./sweetalert2.esm.all-C9HRBEaT.js";import{s as b}from"./supabase-CFADINa5.js";const m="555255",y=sessionStorage.getItem("internal_key"),l=(t,n=document)=>n.querySelector(t),w=l("#tbody"),v=l("#totales"),d=l("#search"),E=l("#btnExportCsv");function f(t){const n=parseInt(t,10);return Number.isNaN(n)?0:n}async function S(t){if(!Array.isArray(t)||t.length===0)return new Map;const{data:n,error:r}=await b.from("entradas").select("dni_titular, numero").in("dni_titular",t).eq("entregado",!0);if(r)return console.error(r),new Map;const e=new Map;return(n||[]).forEach(({dni_titular:s,numero:o})=>{const a=String(s||""),c=e.get(a)||[];c.push(o),e.set(a,c)}),e.forEach(s=>s.sort((o,a)=>(o??0)-(a??0))),e}async function x(t){w.innerHTML="";const n=Array.from(new Set(t.map(e=>String(e.dni||"")).filter(Boolean))),r=await S(n);t.forEach(e=>{const s=document.createElement("tr");s.className="odd:bg-white even:bg-crema/30";const o=r.get(String(e.dni||""))||[],a=o.length?o.map(c=>`#${c}`).join(", "):"";s.innerHTML=`
      <td class="p-3 whitespace-nowrap text-azuloscuro">${e.dni??""}</td>
      <td class="p-3 text-azuloscuro">${e.nombre??""}</td>
      <td class="p-3 text-center text-azuloscuro font-semibold">${f(e.opciones)}</td>
      <td class="p-3 text-azuloscuro">${a}</td>
    `,w.appendChild(s)})}function L(t){const n=t.reduce((r,e)=>r+f(e.opciones),0);v.innerHTML=`
    <div class="flex flex-wrap gap-3 items-center">
      <span class="ml-auto">Total general: <b>${n}</b></span>
    </div>
  `}function g(t,n){const r=(n||"").trim().toLowerCase();return r?t.filter(e=>String(e.dni||"").toLowerCase().includes(r)||String(e.nombre||"").toLowerCase().includes(r)):t}function C(t,n){const e=[["dni","nombre","opciones_total","pulseras"].join(",")],s=o=>{const a=String(o??"").replaceAll('"','""');return/[",\n]/.test(a)?`"${a}"`:a};return t.forEach(o=>{const a=n?.get(String(o.dni||""))||[],c=a.length?a.map(u=>`#${u}`).join(" "):"",i=[o.dni||"",o.nombre||"",f(o.opciones),c];e.push(i.map(s).join(","))}),e.join(`
`)}async function $(){const{data:t,error:n}=await b.from("invitados").select("dni, nombre, opciones").eq("retiro",!0).order("dni",{ascending:!0});if(n)throw n;return t||[]}async function h(){if(y===m)return!0;const{value:t}=await p.fire({title:"Acceso restringido",input:"password",inputLabel:"Ingresá la clave de acceso",inputPlaceholder:"••••••",confirmButtonText:"Entrar",background:"#f1faee",color:"#1d3557",allowOutsideClick:!1});return t===m?(sessionStorage.setItem("internal_key",t),!0):(await p.fire({icon:"error",title:"Clave incorrecta",text:"No tenés autorización para acceder."}),h())}async function A(){l("#anio").textContent=new Date().getFullYear(),await h();try{let t=await $();const n=async()=>{const r=g(t,d.value||"");await x(r),L(r)};d.addEventListener("input",n),E.addEventListener("click",async()=>{const r=g(t,d.value||""),e=Array.from(new Set(r.map(u=>String(u.dni||"")).filter(Boolean))),s=await S(e),o=C(r,s),a=new Blob([o],{type:"text/csv;charset=utf-8;"}),c=URL.createObjectURL(a),i=document.createElement("a");i.href=c,i.download=`retirados_${new Date().toISOString().slice(0,10)}.csv`,i.click(),URL.revokeObjectURL(c)}),await n()}catch(t){console.error(t),await p.fire({icon:"error",title:"Error",text:"No se pudieron cargar los datos."})}}A();
