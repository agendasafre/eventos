import{S as m}from"./sweetalert2.esm.all-D00jIjAz.js";import"./nav-BTX2NAH9.js";import{s as b}from"./supabase-CFADINa5.js";const f="555255",L=sessionStorage.getItem("internal_key"),d=(t,n=document)=>n.querySelector(t),w=d("#tbody"),_=d("#totales"),p=d("#search"),$=d("#btnExportCsv");function l(t){const n=parseInt(t,10);return Number.isNaN(n)?0:n}async function S(t){if(!Array.isArray(t)||t.length===0)return new Map;const{data:n,error:o}=await b.from("entradas").select("dni_titular, numero").in("dni_titular",t).eq("entregado",!0);if(o)return console.error(o),new Map;const e=new Map;return(n||[]).forEach(({dni_titular:s,numero:r})=>{const a=String(s||""),c=e.get(a)||[];c.push(r),e.set(a,c)}),e.forEach(s=>s.sort((r,a)=>(r??0)-(a??0))),e}async function A(t){w.innerHTML="";const n=Array.from(new Set(t.map(e=>String(e.dni||"")).filter(Boolean))),o=await S(n);t.forEach(e=>{const s=document.createElement("tr");s.className="odd:bg-white even:bg-crema/30";const r=o.get(String(e.dni||""))||[],a=r.length?r.map(c=>`#${c}`).join(", "):"";s.innerHTML=`
      <td class="p-3 whitespace-nowrap text-azuloscuro">${e.dni??""}</td>
      <td class="p-3 text-azuloscuro">${e.nombre??""}</td>
      <td class="p-3 text-center text-azuloscuro font-semibold">${l(e.opciones)}</td>
      <td class="p-3 text-azuloscuro">${a}</td>
    `,w.appendChild(s)})}function M(t){const n=t.reduce((o,e)=>o+l(e.opciones),0);_.innerHTML=`
    <div class="flex flex-wrap gap-3 items-center">
      <span class="ml-auto">Total general: <b>${n}</b></span>
    </div>
  `}function g(t,n){const o=(n||"").trim().toLowerCase();return o?t.filter(e=>String(e.dni||"").toLowerCase().includes(o)||String(e.nombre||"").toLowerCase().includes(o)):t}function k(t,n){const e=[["dni","nombre","opciones_total","pulseras","importe_total","cuotas","importe_cuota","por_planilla"].join(",")],s=r=>{const a=String(r??"").replaceAll('"','""');return/[",\n]/.test(a)?`"${a}"`:a};return t.forEach(r=>{const a=n?.get(String(r.dni||""))||[],c=a.length?a.map(C=>`#${C}`).join(" "):"",i=l(r.opciones),u=!!r.es_manual,y=l(u?i*25e3:i*5e4),v=u?3:4,E=l(u?i*25e3/3:i*5e4/4),x=[r.dni||"",r.nombre||"",i,c,y,v,E,u?"No":"Si"];e.push(x.map(s).join(","))}),e.join(`
`)}async function T(){const{data:t,error:n}=await b.from("invitados").select("dni, nombre, opciones, es_manual").eq("retiro",!0).order("dni",{ascending:!0});if(n)throw n;return t||[]}async function h(){if(L===f)return!0;const{value:t}=await m.fire({title:"Acceso restringido",input:"password",inputLabel:"Ingresá la clave de acceso",inputPlaceholder:"••••••",confirmButtonText:"Entrar",background:"#f1faee",color:"#1d3557",allowOutsideClick:!1});return t===f?(sessionStorage.setItem("internal_key",t),!0):(await m.fire({icon:"error",title:"Clave incorrecta",text:"No tenés autorización para acceder."}),h())}async function j(){d("#anio").textContent=new Date().getFullYear(),await h();try{let t=await T();const n=async()=>{const o=g(t,p.value||"");await A(o),M(o)};p.addEventListener("input",n),$.addEventListener("click",async()=>{const o=g(t,p.value||""),e=Array.from(new Set(o.map(u=>String(u.dni||"")).filter(Boolean))),s=await S(e),r=k(o,s),a=new Blob([r],{type:"text/csv;charset=utf-8;"}),c=URL.createObjectURL(a),i=document.createElement("a");i.href=c,i.download=`retirados_${new Date().toISOString().slice(0,10)}.csv`,i.click(),URL.revokeObjectURL(c)}),await n()}catch(t){console.error(t),await m.fire({icon:"error",title:"Error",text:"No se pudieron cargar los datos."})}}j();
