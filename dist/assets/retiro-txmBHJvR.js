import{u as r,s as p}from"./ui-Cf0ssn9_.js";import{p as D}from"./api-Ddpk_UT3.js";const E="/api/retirar",o=(t,e=document)=>e.querySelector(t),I=o("#form"),N=o("#dni"),C=o("#nombre"),x=o("#correo"),v=o("#comun"),f=o("#celiacos"),g=o("#vegetarianos"),h=o("#veganos"),P=o("#totalNum"),l=o("#retiroSection"),y=o("#pulserasContainer"),b=o("#listaPulseras");o("#submitBtn");let c=null,m=!1,i=[];const n=t=>Number.isNaN(parseInt(t,10))?0:parseInt(t,10);function L(){return n(v.value)+n(f.value)+n(g.value)+n(h.value)}function _(t){b.innerHTML="",t.forEach(e=>{const a=document.createElement("span");a.textContent=`#${e}`,a.className="bg-celeste text-azuloscuro px-3 py-1 rounded-full font-medium shadow-sm",b.appendChild(a)}),y.classList.remove("hidden")}N.addEventListener("blur",async()=>{const t=N.value.trim();if(t){r.loading("Verificando DNI...");try{const{data:e,error:a}=await p.from("invitados").select("*").eq("dni",t).maybeSingle();if(r.close(),a||!e){m=!1,r.error("DNI no encontrado o no habilitado."),l.classList.add("hidden");return}if(e.retiro===!0){m=!1,r.info("Este DNI ya retiró sus entradas."),l.classList.add("hidden");return}c=e,m=!0,C.value=e.nombre||"",x.value=e.correo||"",v.value=e.opciones_comun||0,f.value=e.opciones_celiacos||0,g.value=e.opciones_vegetarianos||0,h.value=e.opciones_veganos||0;const s=L();P.textContent=s;const{data:u,error:d}=await p.from("entradas").select("numero").eq("entregado",!1).order("numero",{ascending:!0}).limit(s);if(d)throw d;i=(u||[]).map(w=>w.numero),_(i),r.success("DNI validado correctamente."),l.classList.remove("hidden")}catch(e){r.close(),console.error(e),r.error("Error al verificar el DNI."),l.classList.add("hidden")}}});I.addEventListener("submit",async t=>{if(t.preventDefault(),!m||!c)return r.error("Validá primero el DNI.");const e=L();if(e<1)return r.info("El total de menús debe ser mayor a 0.");if(!i.length)return r.info("No hay pulseras disponibles.");const a={invitado:c,numeros:i,comun:n(v.value),celiacos:n(f.value),vegetarianos:n(g.value),veganos:n(h.value),total:e};try{r.loading("Registrando retiro...");const{error:s}=await p.from("invitados").update({retiro:!0}).eq("id",c.id);if(s)throw s;const{error:u}=await p.from("entradas").update({entregado:!0,dni_titular:c.dni}).in("numero",i);if(u)throw u;const d=await D(E,a);r.close(),r.success("Retiro registrado y correo enviado."),console.log("Correo:",d),I.reset(),i=[],y.classList.add("hidden"),l.classList.add("hidden")}catch(s){r.close(),console.error(s),r.error("No se pudo registrar el retiro.")}});o("#anio").textContent=new Date().getFullYear();
