import{u as n,s as b}from"./ui-Cf0ssn9_.js";import{p as w}from"./api-Ddpk_UT3.js";const q="/api/retirar",o=(e,t=document)=>t.querySelector(e),P=o("#form"),h=o("#dni"),_=o("#nombre"),C=o("#correo"),c=o("#comun"),d=o("#celiacos"),m=o("#vegetarianos"),f=o("#veganos"),x=o("#totalNum"),l=o("#pulserasContainer"),y=o("#listaPulseras"),N=o("#submitBtn");let v=null,i=!1;const a=e=>Number.isNaN(parseInt(e,10))?0:parseInt(e,10);function I(){return a(c.value)+a(d.value)+a(m.value)+a(f.value)}function u(e=!0){[c,d,m,f].forEach(r=>{e?r.setAttribute("readonly",!0):r.removeAttribute("readonly")}),N.disabled=e||I()<1}function E(){const e=I();x.textContent=e,N.disabled=!i||e<1}function L(e){Array.isArray(e)&&(y.innerHTML="",e.forEach(t=>{const r=document.createElement("span");r.textContent=`#${t}`,r.className="bg-celeste text-azuloscuro px-3 py-1 rounded-full font-medium shadow-sm",y.appendChild(r)}),l.classList.remove("hidden"))}async function A(e,t=null){const r=b.from("entradas").select("numero").eq("dni_titular",e).eq("entregado",!0).order("numero",{ascending:!0}),{data:s,error:p}=t?await r.limit(t):await r;return p?(console.error(p),[]):(s||[]).map(g=>g.numero)}h.addEventListener("blur",async()=>{const e=h.value.trim();if(e){n.loading("Verificando DNI...");try{const{data:t,error:r}=await b.from("invitados").select("*").eq("dni",e).maybeSingle();if(n.close(),r||!t){i=!1,n.error("DNI no encontrado o no habilitado."),u(!0),l.classList.add("hidden");return}if(v=t,_.value=t.nombre||"",C.value=t.correo||"",!t.acepto_terminos){i=!1,n.info("El invitado no aceptó los términos."),u(!0),l.classList.add("hidden");return}if(t.retiro===!0){i=!1,n.info("Este invitado ya retiró sus entradas."),u(!0);const{data:s,error:p}=await b.from("entradas").select("numero").eq("dni_titular",e).eq("entregado",!0).order("numero",{ascending:!0});if(!p&&s?.length){const g=s.map(D=>D.numero);L(g)}else l.classList.add("hidden");return}c.value=t.opciones_comun||0,d.value=t.opciones_celiacos||0,m.value=t.opciones_vegetarianos||0,f.value=t.opciones_veganos||0,i=!0,u(!1),E(),n.success("DNI validado. Podés registrar el retiro."),l.classList.add("hidden")}catch(t){n.close(),console.error(t),n.error("Error al verificar el DNI."),u(!0),l.classList.add("hidden")}}});[c,d,m,f].forEach(e=>{e.addEventListener("input",E)});P.addEventListener("submit",async e=>{if(e.preventDefault(),!i||!v)return n.error("Validá primero el DNI.");const t=I();if(t<1)return n.info("El total de menús debe ser mayor a 0.");try{n.loading("Registrando retiro...");const r={dni:v.dni,comun:a(c.value),celiacos:a(d.value),vegetarianos:a(m.value),veganos:a(f.value)};await w(q,r);const s=await A(v.dni,t);s.length&&L(s),n.close(),n.success("Retiro registrado y correo enviado."),u(!0),i=!1}catch(r){n.close(),console.error(r),n.error("No se pudo registrar el retiro.")}});o("#anio").textContent=new Date().getFullYear();
