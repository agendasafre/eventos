import{s as D}from"./sweetalert2.esm.all-BLV7cngM.js";import{u as r}from"./ui-BYrQ5bxj.js";const P="4",M=sessionStorage.getItem("internal_key");async function T(){const{value:o}=await Swal.fire({title:"Acceso restringido",input:"password",inputLabel:"Ingresá la clave de acceso",inputPlaceholder:"••••••",confirmButtonText:"Entrar",background:"#f1faee",color:"#1d3557",allowOutsideClick:!1});return o===P?(sessionStorage.setItem("internal_key",o),!0):(await Swal.fire({icon:"error",title:"Clave incorrecta",text:"No tenés autorización para acceder.",confirmButtonColor:"#457b9d"}),T())}M!==P&&await T();const A="/api/retirar",n=(o,e=document)=>e.querySelector(o),B=n("#form"),x=n("#dni"),s=n("#nombre"),l=n("#correo"),d=n("#comun"),f=n("#celiacos"),v=n("#vegetarianos"),p=n("#veganos"),w=n("#totalNum"),C=n("#pulserasContainer"),h=n("#listaPulseras"),N=n("#submitBtn"),L=n("#datosInvitado"),S=[s,l,d,f,v,p],F=[d,f,v,p];let i=null,u=!1;function O(){s.value="",l.value="",F.forEach(o=>{o.value="0"}),w.textContent="0",h.innerHTML="",C.classList.add("hidden")}function y({reset:o=!0}={}){L.classList.add("hidden"),S.forEach(e=>{e.disabled=!0}),N.disabled=!0,o&&O()}function $(){L.classList.remove("hidden"),S.forEach(o=>{o.disabled=!1}),I()}function k(){S.forEach(o=>{o.disabled=!0}),N.disabled=!0}const t=o=>Number.isNaN(parseInt(o,10))?0:parseInt(o,10);function b(){return t(d.value)+t(f.value)+t(v.value)+t(p.value)}function I(){const o=b();w.textContent=o,s.value.trim().length>0,l.value.trim().length>0,N.disabled=!u||s.disabled}function q(o){Array.isArray(o)&&(h.innerHTML="",o.forEach(e=>{const a=document.createElement("span");a.textContent=`#${e}`,a.className="bg-celeste text-azuloscuro px-3 py-1 rounded-full font-medium shadow-sm",h.appendChild(a)}),C.classList.remove("hidden"))}async function j(o,e=null){const a=D.from("entradas").select("numero").eq("dni_titular",o).eq("entregado",!0).order("numero",{ascending:!0}),{data:c,error:g}=e?await a.limit(e):await a;return g?(console.error(g),[]):(c||[]).map(m=>m.numero)}y();x.addEventListener("blur",async()=>{const o=x.value.trim();if(!o){i=null,u=!1,y();return}i=null,u=!1,y(),r.loading("Verificando DNI...");try{const{data:e,error:a}=await D.from("invitados").select("*").eq("dni",o).maybeSingle();if(r.close(),a||!e){r.error("DNI no encontrado o no habilitado.");return}if(i=e,e.retiro===!0){s.value=e.nombre||"",l.value=e.correo||"",d.value=t(e.opciones_comun),f.value=t(e.opciones_celiacos),v.value=t(e.opciones_vegetarianos),p.value=t(e.opciones_veganos),w.textContent=b(),k(),L.classList.remove("hidden"),r.info("Este invitado ya retiró sus entradas.");const c=await j(o);c.length&&q(c),i=null;return}if(e.estado!=="registrado"){r.info("El invitado no completó el registro."),i=null;return}s.value=e.nombre||"",l.value=e.correo||"",d.value=t(e.opciones_comun),f.value=t(e.opciones_celiacos),v.value=t(e.opciones_vegetarianos),p.value=t(e.opciones_veganos),C.classList.add("hidden"),h.innerHTML="",u=!0,$(),I(),r.success(`Invitado validado. Total de menús: ${b()}.`)}catch(e){r.close(),console.error(e),r.error("Error al verificar el DNI."),i=null,u=!1}});F.forEach(o=>{o.addEventListener("input",()=>{const e=t(o.value);o.value=e<0?"0":`${e}`,I()})});[s,l].forEach(o=>{o.addEventListener("input",I)});B.addEventListener("submit",async o=>{if(o.preventDefault(),!u||!i)return r.error("Validá primero el DNI.");const e=[],a=s.value.trim(),c=l.value.trim(),g=b();if(a||e.push("Completá el nombre."),c||e.push("Completá el correo."),g<1&&e.push("Seleccioná al menos un menú."),e.length){r.info(e.join(" ")),a?c?d.focus():l.focus():s.focus();return}try{r.loading("Registrando retiro...");const m={dni:i.dni,nombre:s.value.trim(),correo:l.value.trim(),comun:t(d.value),celiacos:t(f.value),vegetarianos:t(v.value),veganos:t(p.value)},_=await fetch(A,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)}),E=await _.json();if(!_.ok)throw new Error(E?.error||"Error en retiro");q(E.numeros),r.close(),r.success(E?.message||"Retiro registrado y correo enviado."),k(),u=!1,i.retiro=!0}catch(m){r.close(),console.error(m),r.error(m.message||"No se pudo registrar el retiro.")}});n("#anio").textContent=new Date().getFullYear();
