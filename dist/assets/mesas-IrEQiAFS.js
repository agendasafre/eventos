import{s as S}from"./sweetalert2.esm.all-C9FIaYH4.js";import{u as r}from"./ui-D9-0gNA8.js";import{p as q}from"./api-Ddpk_UT3.js";const N=(n,e=document)=>e.querySelector(n),_=N("#mesasContainer"),v=N("#confirmBtn");N("#anio").textContent=new Date().getFullYear();const B="/api/confirmar",T=new URLSearchParams(window.location.search).get("token");if(!T)throw r.error("No se encontró el token de acceso."),new Error("Token faltante");let o={invitado:null,mesas:[],confirmed:[],draft:[],pendingMove:null,draftCounter:0,realtimeChannel:null,realtimeSyncing:!1,realtimeQueued:!1,lastRealtimeNoticeAt:0};const h=(n,e)=>`${n}:${e}`;function E(){const n=o.invitado||{};return(n.opciones_comun||0)+(n.opciones_celiacos||0)+(n.opciones_vegetarianos||0)+(n.opciones_veganos||0)}function H(){o.draft=o.confirmed.map(n=>({...n,clientId:`seat-${n.id}`,originalMesaId:n.mesa_id,originalPosicion:n.posicion,isNew:!1,isMoved:!1,proposedCambios:n.cambios})),o.pendingMove=null,I()}function j(){const n=new Map;return o.draft.forEach(e=>{e.mesa_id&&e.posicion&&n.set(h(e.mesa_id,e.posicion),e)}),n}function $(){if(o.draft.length!==o.confirmed.length)return!0;const n=new Map;o.confirmed.forEach(e=>n.set(e.id,e));for(const e of o.draft){if(!e.id)return!0;const t=n.get(e.id);if(!t||e.mesa_id!==t.mesa_id||e.posicion!==t.posicion||(e.proposedCambios||e.cambios)!==t.cambios)return!0}return!1}function Q(){return o.draft.length!==E()}function I(){const n=$(),e=Q();if(!n||e){v.classList.add("hidden"),v.disabled=!0;return}v.classList.remove("hidden"),v.disabled=!1}function F(){const n=E(),e=o.draft.length,t=Math.max(n-e,0),s=$()?'<span class="text-orange-500 font-semibold">Tenés cambios sin confirmar.</span>':'<span class="text-green-600 font-semibold">Todo guardado.</span>',a=`
    <div class="mb-6 text-center bg-white/90 p-4 rounded-xl shadow">
      <p class="text-azuloscuro font-semibold">
        Tenés <b>${n}</b> asiento${n!==1?"s":""} disponible${n!==1?"s":""}.
      </p>
      <p class="text-sm text-gray-600">
        Seleccionaste ${e}, te quedan ${t}.
      </p>
      <p class="text-xs text-gray-500 mt-1">
        Podés cambiar cada asiento hasta <b>2 veces</b>.
      </p>
      <p class="text-xs mt-2">${s}</p>
    </div>
  `;N("#estadoAsientos")?.remove();const l=document.createElement("div");l.id="estadoAsientos",l.innerHTML=a,_.before(l)}function U(n){const e=new Map;return(n||[]).forEach(t=>{(t.mesa_asientos||[]).forEach(i=>{i&&e.set(h(t.id,i.posicion),{mesa_id:t.id,...i})})}),e}function Y(n,e,{preserveDraft:t=!1}={}){const i=n||[],s=[],a=U(i);if(i.forEach(d=>{(d.mesa_asientos||[]).forEach(f=>{f?.invitado_id===e&&s.push({id:f.id,mesa_id:d.id,posicion:f.posicion,cambios:f.cambios||0})})}),o.mesas=i,o.confirmed=s,!t)return H(),{removedKeys:[],occupancy:a};const l=[],c=[],m=o.pendingMove?h(o.pendingMove.fromMesaId,o.pendingMove.fromPosicion):null;if(o.draft.forEach(d=>{const f=h(d.mesa_id,d.posicion),p=a.get(f);if(p&&p.invitado_id&&p.invitado_id!==e){c.push(f);return}p&&p.invitado_id===e&&(d.id=p.id,d.cambios=p.cambios||0,d.proposedCambios=d.proposedCambios??d.cambios,d.isNew=!1,d.isMoved=!1),l.push(d)}),o.draft=l,m){const d=a.get(m);(!d||d.invitado_id!==e)&&(o.pendingMove=null)}return{removedKeys:c,occupancy:a}}async function C({showLoading:n=!1,preserveDraft:e=!1,loadingMessage:t="Actualizando mesas..."}={}){try{if(n&&r.loading(t),!o.invitado||!e){const{data:l,error:c}=await S.from("invitados").select("*").eq("mesa_token",T).maybeSingle();if(c||!l)throw new Error("Token inválido");o.invitado=l}const{data:i,error:s}=await S.from("mesas").select(`
        id,
        numero,
        capacidad,
        mesa_asientos (
          id,
          posicion,
          invitado_id,
          cambios,
          invitados ( nombre )
        )
      `).order("numero",{ascending:!0});if(s)throw s;const{removedKeys:a}=Y(i,o.invitado.id,{preserveDraft:e});if(w(),e&&a.length){const l=Date.now();if(l-o.lastRealtimeNoticeAt>3e3){const c=a.length===1?"Un asiento que estabas mirando fue tomado por otra persona. Actualizamos tu selección.":"Algunos asientos que estabas mirando fueron tomados por otras personas. Actualizamos tu selección.";r.info(c),o.lastRealtimeNoticeAt=l}}}catch(i){console.error(i),e||r.error("Error al cargar las mesas.")}finally{n&&r.close()}}function J(){_.innerHTML="";const n=j(),e=o.pendingMove?h(o.pendingMove.fromMesaId,o.pendingMove.fromPosicion):null;o.mesas.forEach(t=>{const i=document.createElement("div");i.className="bg-white/90 rounded-2xl shadow-md p-5 flex flex-col items-center text-center transition-transform hover:scale-105 m-2";const s=document.createElement("h2");s.className="text-azuloscuro font-bold mb-4",s.textContent=`Mesa ${t.numero}`,i.appendChild(s);const a=document.createElement("div");a.className="grid grid-cols-4 gap-3";const l=t.capacidad||8;for(let c=1;c<=l;c+=1){const m=(t.mesa_asientos||[]).find(K=>K.posicion===c)||null,d=h(t.id,c),f=n.get(d),p=m?.invitado_id&&m.invitado_id!==o.invitado.id,k=!!m&&m.invitado_id===o.invitado.id,O=!!f,D=f?.isNew||f?.isMoved,R=e===d,u=document.createElement("button");u.dataset.mesa=t.id,u.dataset.pos=c,u.className="asiento w-12 h-12 rounded-full flex items-center justify-center transition border";const g=document.createElement("i");g.classList.add("fa-solid");let y="Disponible",b="Disponible",M="text-transparent";p?(u.classList.add("bg-rojo","text-white","cursor-not-allowed"),u.disabled=!0,g.classList.add("fa-user-slash"),y=m?.invitados?.nombre||"Ocupado",b=m?.invitados?.nombre||"Ocupado",M="text-gray-800"):R&&k?(u.classList.add("border-2","border-dashed","border-azuloscuro","bg-azuloscuro/10","text-azuloscuro"),g.classList.add("fa-person-walking-arrow-right"),y="Liberado para mover",b="Elegí tu nuevo asiento",M="text-azuloscuro font-semibold"):O?(u.classList.add("border-4","border-emerald-400","bg-emerald-50"),g.classList.add("fa-star","text-emerald-500"),y=D?"Nuevo asiento seleccionado":"Tu asiento",b=D?"Nuevo":"Confirmado",M="text-emerald-600"):k?(u.classList.add("border-4","border-yellow-400","bg-yellow-50"),g.classList.add("fa-star","text-yellow-400"),y="Tu asiento actual",b="Actual",M="text-yellow-500"):(u.classList.add("border","border-celeste","hover:border-azuloscuro","hover:bg-celeste/20"),g.classList.add("fa-chair","text-amber-800")),u.title=y,u.appendChild(g);const x=document.createElement("div");x.className="flex flex-col items-center justify-center text-center",x.appendChild(u);const L=document.createElement("p");L.className=`text-sm mt-1 max-w-[120px] leading-tight ${M}`,L.textContent=b==="Disponible"?".":b,x.appendChild(L),a.appendChild(x)}i.appendChild(a),_.appendChild(i)})}function w(){F(),J(),I()}function A(n,e){return o.draft.find(t=>t.mesa_id===n&&t.posicion===e)}function G(n){return o.draft.find(e=>e.clientId===n)}function V(n,e,t){if(o.pendingMove){r.info("Primero ubicá el asiento que ya estás moviendo.");return}if(n.cambios>=2){r.info("No podés cambiar este asiento más de 2 veces.");return}o.pendingMove={clientId:n.clientId,fromMesaId:e,fromPosicion:t},w(),r.info("Elegí el nuevo lugar para este asiento.")}function P(){o.pendingMove=null,w()}function W(n){o.draft=o.draft.filter(e=>e.clientId!==n.clientId),w()}function X(n,e){const t=o.pendingMove;if(!t)return;const i=G(t.clientId);if(!i){P();return}const s=(i.cambios||0)+1;if(s>2){r.info("No podés cambiar este asiento más de 2 veces."),P();return}if(A(n,e)){r.info("Ya seleccionaste ese lugar. Elegí otro.");return}i.mesa_id=n,i.posicion=e,i.isMoved=!0,i.cambios=s,i.proposedCambios=s,o.pendingMove=null,w()}function Z(n,e){const t=E();if(o.draft.length>=t){r.info("Ya seleccionaste todos tus asientos disponibles.");return}o.draftCounter+=1,o.draft.push({id:null,mesa_id:n,posicion:e,cambios:0,proposedCambios:0,isNew:!0,isMoved:!1,originalMesaId:null,originalPosicion:null,clientId:`new-${o.draftCounter}`}),w()}function ee(n,e){const t=o.mesas.find(c=>c.id===n);if(!t)return;const i=(t.mesa_asientos||[]).find(c=>c.posicion===e)||null,s=A(n,e),a=o.pendingMove;if(i?.invitado_id&&i.invitado_id!==o.invitado.id){r.info("Ese asiento ya está ocupado.");return}if(s&&s.isNew){W(s);return}if(a&&a.fromMesaId===n&&a.fromPosicion===e){P();return}if(s&&!s.isNew){V(s,n,e);return}if(a){X(n,e);return}if(s){r.info("Ese asiento ya lo tenés reservado.");return}Z(n,e)}_.addEventListener("click",n=>{const e=n.target.closest(".asiento");if(!e)return;const t=parseInt(e.dataset.mesa,10),i=parseInt(e.dataset.pos,10);Number.isNaN(t)||Number.isNaN(i)||ee(t,i)});v.addEventListener("click",async()=>{if(v.disabled)return;if(!$()){r.info("No hay cambios para confirmar.");return}const e=E();if(o.draft.length!==e){r.info(`Debés seleccionar ${e} asiento${e!==1?"s":""} antes de confirmar.`);return}try{r.loading("Confirmando selección...");const t={token:T,asientos:o.draft.map(a=>({id:a.id,mesa_id:a.mesa_id,posicion:a.posicion,original_mesa_id:a.originalMesaId,original_posicion:a.originalPosicion,cambios:a.proposedCambios??a.cambios}))},i=await q(B,t),s=JSON.parse(i||"{}");r.close(),r.success(s?.message||"¡Listo! Guardamos tu selección."),await C({showLoading:!0})}catch(t){console.error(t),r.close();try{const i=JSON.parse(t.message);r.error(i?.error||"No pudimos guardar tus asientos.")}catch{r.error(t.message||"No pudimos guardar tus asientos.")}await C({preserveDraft:!0})}});async function z(){if(o.realtimeSyncing){o.realtimeQueued=!0;return}o.realtimeSyncing=!0;try{await C({preserveDraft:!0})}finally{o.realtimeSyncing=!1,o.realtimeQueued&&(o.realtimeQueued=!1,z())}}function ne(){if(o.realtimeChannel)return;const n=S.channel("mesa-asientos-changes").on("postgres_changes",{event:"*",schema:"public",table:"mesa_asientos"},()=>{z()}).subscribe();o.realtimeChannel=n}window.addEventListener("beforeunload",()=>{o.realtimeChannel?.unsubscribe()});async function oe(){await C({showLoading:!0,loadingMessage:"Cargando mesas..."}),ne()}oe();
